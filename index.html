<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI for Bharat - Crop Price Advisor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&family=Noto+Sans+Tamil:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --bg: #f0ede8;
      --bg-deep: #e6e0d8;
      --card: #ffffff;
      --card-shadow: rgba(0,0,0,0.06);
      --text: #1c1a17;
      --muted: #7a746b;
      --accent-veg: #3a7d5c;
      --accent-veg-light: #eaf6ef;
      --accent-grain: #c48a1e;
      --accent-grain-light: #fdf3e0;
      --border: #ddd8cf;
      --toggle-bg: #cbd5e0;
      --toggle-knob: #fff;
      --toggle-shadow: rgba(0,0,0,0.15);
      --overlay: rgba(0,0,0,0.55);
      --blue: #3b82f6;
      --blue-light: #dbeafe;
    }

    body.dark {
      --bg: #16161a;
      --bg-deep: #1e1e24;
      --card: #24242c;
      --card-shadow: rgba(0,0,0,0.3);
      --text: #eceae6;
      --muted: #8a8580;
      --accent-veg: #5aad82;
      --accent-veg-light: rgba(90,173,130,0.12);
      --accent-grain: #dba032;
      --accent-grain-light: rgba(219,160,50,0.12);
      --border: #2e2e36;
      --toggle-bg: #2a3040;
      --toggle-shadow: rgba(0,0,0,0.4);
      --overlay: rgba(0,0,0,0.65);
      --blue: #60a5fa;
      --blue-light: rgba(96,165,250,0.15);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background 0.4s, color 0.4s;
      -webkit-font-smoothing: antialiased;
      padding-bottom: 20px;
    }

    body.lang-hi, body.lang-mr { font-family: 'Noto Sans Devanagari', 'DM Sans', sans-serif; }
    body.lang-ta { font-family: 'Noto Sans Tamil', 'DM Sans', sans-serif; }
    body.lang-en { font-family: 'DM Sans', sans-serif; }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
    }

    /* ========== HEADER ========== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      gap: 8px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 1px 3px var(--card-shadow);
    }

    .location {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 13px;
      color: var(--text);
      background: var(--bg);
      padding: 6px 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      white-space: nowrap;
      flex-shrink: 1;
      min-width: 0;
    }
    .location .pin { font-size: 14px; flex-shrink: 0; }
    .location .loc-text { overflow: hidden; text-overflow: ellipsis; }

    .lang-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, transform 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .lang-btn:hover { border-color: var(--accent-veg); }
    .lang-btn:active { transform: scale(0.95); }
    .lang-btn .globe { font-size: 14px; }
    .lang-btn .lang-code {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    .lang-btn .chevron {
      font-size: 8px;
      color: var(--muted);
      transition: transform 0.25s;
    }
    .lang-btn.open .chevron { transform: rotate(180deg); }

    .toggle-wrap {
      position: relative;
      width: 68px;
      height: 34px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .toggle-track {
      width: 100%;
      height: 100%;
      border-radius: 17px;
      background: var(--toggle-bg);
      position: relative;
      overflow: hidden;
      transition: background 0.45s cubic-bezier(.4,0,.2,1);
    }

    .toggle-wrap::before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 20px;
      background: linear-gradient(135deg, #fde68a, #86efac);
      opacity: 0.35;
      z-index: 0;
      transition: opacity 0.45s, background 0.45s;
    }
    body.dark .toggle-wrap::before {
      background: linear-gradient(135deg, #7dd3fc, #a78bfa);
      opacity: 0.3;
    }
    .toggle-track { position: relative; z-index: 1; }

    .t-star {
      position: absolute;
      width: 3px; height: 3px;
      border-radius: 50%;
      background: #fff;
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .t-star-1 { top: 7px; left: 12px; }
    .t-star-2 { top: 20px; left: 18px; width: 2px; height: 2px; }
    .t-star-3 { top: 11px; left: 28px; width: 2.5px; height: 2.5px; }
    body.dark .t-star { opacity: 0.8; }

    .t-cloud {
      position: absolute;
      background: rgba(255,255,255,0.7);
      border-radius: 10px;
      transition: opacity 0.35s ease, transform 0.45s ease;
    }
    .t-cloud-1 { width: 17px; height: 7px; top: 8px; right: 8px; }
    .t-cloud-2 { width: 10px; height: 6px; top: 18px; right: 14px; }
    body.dark .t-cloud { opacity: 0; transform: translateX(12px); }

    .toggle-knob {
      width: 26px; height: 26px;
      border-radius: 50%;
      background: var(--toggle-knob);
      box-shadow: 0 2px 6px var(--toggle-shadow);
      position: absolute;
      top: 4px; left: 4px;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: transform 0.45s cubic-bezier(.4,0,.2,1), box-shadow 0.3s;
    }
    body.dark .toggle-knob {
      transform: translateX(34px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }
    .toggle-knob .icon-sun,
    .toggle-knob .icon-moon { transition: opacity 0.3s, transform 0.4s; position: absolute; }
    .toggle-knob .icon-sun  { opacity: 1; transform: scale(1) rotate(0deg); }
    .toggle-knob .icon-moon { opacity: 0; transform: scale(0.5) rotate(-30deg); }
    body.dark .toggle-knob .icon-sun  { opacity: 0; transform: scale(0.5) rotate(30deg); }
    body.dark .toggle-knob .icon-moon { opacity: 1; transform: scale(1) rotate(0deg); }

    /* ========== HERO ========== */
    .hero {
      padding: 24px 16px 20px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }
    .hero-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--accent-veg);
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }
    .hero-title {
      font-family: 'Playfair Display', serif;
      font-size: 32px;
      font-weight: 700;
      line-height: 1.25;
      margin-bottom: 10px;
      color: var(--text);
    }
    .hero-title em {
      font-style: italic;
      color: var(--accent-veg);
    }
    .hero-sub {
      font-size: 14px;
      line-height: 1.6;
      color: var(--muted);
      max-width: 90%;
    }

    /* ========== CROP CARDS ========== */
    .crops-container {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .crop-card {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px var(--card-shadow);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .crop-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--card-shadow);
    }

    .crop-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }

    .crop-emoji {
      font-size: 48px;
      width: 64px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      border-radius: 12px;
    }

    .crop-title-section {
      flex: 1;
    }

    .crop-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .crop-category {
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
      padding: 3px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .crop-category.vegetable {
      background: var(--accent-veg-light);
      color: var(--accent-veg);
    }
    .crop-category.grain {
      background: var(--accent-grain-light);
      color: var(--accent-grain);
    }

    /* Market Recommendation */
    .market-recommendation {
      background: var(--blue-light);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
      border: 1px solid var(--blue);
    }

    .market-label {
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 600;
      color: var(--blue);
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .market-name {
      font-size: 18px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 2px;
      text-transform: capitalize;
      letter-spacing: 0.3px;
    }

    .market-state {
      font-size: 13px;
      color: var(--muted);
      text-transform: capitalize;
    }

    .market-price {
      font-size: 28px;
      font-weight: 700;
      color: var(--blue);
      margin-top: 8px;
    }

    .market-price .unit {
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      margin-left: 4px;
    }

    /* Explanation */
    .explanation {
      background: var(--bg);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.6;
      color: var(--text);
    }

    .explanation-icon {
      display: inline-block;
      margin-right: 6px;
      font-size: 16px;
    }

    /* 7-Day Forecast */
    .forecast-section {
      margin-top: 16px;
    }

    .forecast-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .forecast-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .expand-btn {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    .expand-btn:hover {
      background: var(--border);
    }
    .expand-btn .arrow {
      display: inline-block;
      transition: transform 0.3s;
      margin-left: 4px;
    }
    .expand-btn.expanded .arrow {
      transform: rotate(180deg);
    }

    .forecast-grid {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: var(--bg);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .forecast-grid.visible {
      display: block;
    }

    .chart-container {
      position: relative;
      height: 200px;
      margin-bottom: 20px;
    }

    .chart-svg {
      width: 100%;
      height: 100%;
    }

    .chart-line {
      fill: none;
      stroke: var(--blue);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .chart-area {
      fill: var(--blue);
      opacity: 0.1;
    }

    .chart-point {
      fill: var(--blue);
      stroke: var(--card);
      stroke-width: 2;
      cursor: pointer;
      transition: r 0.2s;
    }

    .chart-point:hover {
      r: 6;
    }

    .chart-grid-line {
      stroke: var(--border);
      stroke-width: 1;
      stroke-dasharray: 4;
    }

    .chart-label {
      font-size: 10px;
      fill: var(--muted);
      font-weight: 600;
    }

    .chart-value {
      font-size: 11px;
      fill: var(--text);
      font-weight: 700;
    }

    .range-band {
      fill: var(--blue);
      opacity: 0.18;
    }

    .forecast-legend {
      display: flex;
      justify-content: space-around;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 11px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-color {
      width: 16px;
      height: 3px;
      border-radius: 2px;
    }

    .legend-predicted {
      background: var(--blue);
    }

    .legend-range {
      background: var(--blue);
      opacity: 0.3;
    }

    /* Price Range Indicator */
    .price-range {
      margin-top: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: 10px;
    }

    .range-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }

    .range-bar {
      height: 6px;
      background: linear-gradient(to right, #ef4444, #fbbf24, #22c55e);
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }

    .range-indicator {
      position: absolute;
      top: -4px;
      width: 14px;
      height: 14px;
      background: var(--text);
      border-radius: 50%;
      border: 2px solid var(--card);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Loading & Error States */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent-veg);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      padding: 20px;
      margin: 20px 16px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      color: #ef4444;
      text-align: center;
      line-height: 1.6;
    }

    /* Language Drawer */
    .lang-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay);
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .lang-overlay.visible { opacity: 1; pointer-events: auto; }

    .lang-drawer {
      position: fixed;
      bottom: 0; left: 50%;
      transform: translateX(-50%) translateY(100%);
      width: 100%;
      max-width: 480px;
      background: var(--card);
      border-radius: 22px 22px 0 0;
      padding: 10px 20px 36px;
      z-index: 101;
      transition: transform 0.38s cubic-bezier(.4,0,.2,1);
      box-shadow: 0 -8px 40px rgba(0,0,0,0.18);
    }
    .lang-drawer.visible { transform: translateX(-50%) translateY(0); }

    .drawer-handle {
      width: 40px;
      height: 4px;
      border-radius: 2px;
      background: var(--muted);
      margin: 8px auto 20px;
      opacity: 0.4;
    }

    .drawer-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 14px;
      color: var(--text);
    }

    .lang-list { display: flex; flex-direction: column; gap: 3px; }

    .lang-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 13px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      background: transparent;
    }
    .lang-option:hover { background: var(--bg); }
    .lang-option:active { transform: scale(0.98); }

    .lang-flag {
      font-size: 26px;
      width: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lang-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .lang-native {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .lang-english {
      font-size: 12px;
      color: var(--muted);
    }
    .lang-check {
      color: var(--accent-veg);
      font-size: 18px;
      opacity: 0;
      transition: opacity 0.25s;
    }
    .lang-option.active .lang-check { opacity: 1; }

    /* Footer */
    .footer {
      padding: 20px 16px;
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.6;
    }

    .disclaimer {
      background: var(--bg);
      padding: 12px 16px;
      margin: 16px;
      border-radius: 10px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
      text-align: center;
      border: 1px solid var(--border);
    }

    /* Responsive adjustments */
    @media (max-width: 400px) {
      .hero-title {
        font-size: 28px;
      }
      .chart-container {
        height: 180px;
      }
    }
  </style>
</head>
<body>

<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="location">
      <span class="pin">üìç</span>
      <span class="loc-text" data-i18n="location"></span>
    </div>

    <div class="lang-btn" id="langBtn" tabindex="0" role="button" onclick="toggleDrawer()">
      <span class="globe">üåê</span>
      <span class="lang-code" id="langCode">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span>
      <span class="chevron">‚ñº</span>
    </div>

    <div class="toggle-wrap" onclick="toggleTheme()" tabindex="0" role="button">
      <div class="toggle-track">
        <div class="t-star t-star-1"></div>
        <div class="t-star t-star-2"></div>
        <div class="t-star t-star-3"></div>
        <div class="t-cloud t-cloud-1"></div>
        <div class="t-cloud t-cloud-2"></div>
        <div class="toggle-knob">
          <span class="icon-sun">‚òÄÔ∏è</span>
          <span class="icon-moon">üåô</span>
        </div>
      </div>
    </div>
  </div>

  <!-- HERO -->
  <div class="hero">
    <div class="hero-label" data-i18n="heroLabel"></div>
    <h1 class="hero-title" data-i18n-html="heroTitle"></h1>
    <p class="hero-sub" data-i18n="heroSub"></p>
  </div>

  <!-- MAIN CONTENT -->
  <div id="mainContent">
    <div class="loading">
      <div class="loading-spinner"></div>
      <div data-i18n="loading"></div>
    </div>
  </div>

  <!-- DISCLAIMER -->
  <div class="disclaimer" id="disclaimer" style="display: none;">
    <span data-i18n="disclaimer"></span>
  </div>

  <!-- FOOTER -->
  <div class="footer">
    <div data-i18n="project"></div>
  </div>
</div>

<!-- LANGUAGE DRAWER -->
<div class="lang-overlay" id="langOverlay" onclick="closeDrawer()"></div>
<div class="lang-drawer" id="langDrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-title" data-i18n="chooseLang"></div>
  <div class="lang-list" id="langList"></div>
</div>

<script>
/* ============================================================
   API CONFIGURATION
   ============================================================ */
const API_URL = 'https://cvaxb6t5aa.execute-api.ap-south-1.amazonaws.com/prod/api/data';

/* ============================================================
   TRANSLATIONS
   ============================================================ */
const langs = {
  hi: {
    code: "‡§π‡§ø‡§®‡•ç‡§¶‡•Ä",
    english: "Hindi",
    location: "‡§≤‡§ñ‡§®‡•å, ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂",
    heroLabel: "üöÄ ‡§≠‡§æ‡§∞‡§§ ‡§ï‡•á ‡§≤‡§ø‡§è AI",
    heroTitle: "‡§π‡§∞ ‡§´‡§∏‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è<br/><em>‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§¶‡§æ‡§Æ</em>",
    heroSub: "AI ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§≤‡§æ‡§á‡§µ ‡§´‡§∏‡§≤ ‡§¶‡§æ‡§Æ ‡§î‡§∞ 7-‡§¶‡§ø‡§® ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§® ‚Äî ‡§ï‡§ø‡§∏‡§æ‡§®‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡§¨‡§∏‡•á ‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§Æ‡§Ç‡§°‡•Ä ‡§ñ‡•ã‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶‡•§",
    onion: "‡§™‡•ç‡§Ø‡§æ‡§ú‡§º",
    potato: "‡§Ü‡§≤‡•Ç",
    wheat: "‡§ó‡•á‡§π‡•Ç‡§Å",
    tomato: "‡§ü‡§Æ‡§æ‡§ü‡§∞",
    rice: "‡§ö‡§æ‡§µ‡§≤",
    vegetable: "‡§∏‡§¨‡•ç‡§ú‡•Ä",
    grain: "‡§Ö‡§®‡§æ‡§ú",
    recommendedMarket: "‡§∏‡•Å‡§ù‡§æ‡§à ‡§ó‡§à ‡§Æ‡§Ç‡§°‡•Ä",
    avgPrice: "‡§î‡§∏‡§§ ‡§¶‡§æ‡§Æ (7 ‡§¶‡§ø‡§®)",
    perQuintal: "‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡•Å‡§Ç‡§ü‡§≤",
    forecast7Days: "üìä 7-‡§¶‡§ø‡§® ‡§ï‡§æ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§®",
    viewForecast: "‡§¶‡•á‡§ñ‡•á‡§Ç",
    hideForecast: "‡§õ‡§ø‡§™‡§æ‡§è‡§Ç",
    priceRange: "‡§¶‡§æ‡§Æ ‡§∏‡•Ä‡§Æ‡§æ",
    predictedPrice: "‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§¶‡§æ‡§Æ",
    lower: "‡§ï‡§Æ",
    upper: "‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ",
    chooseLang: "‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç",
    loading: "‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...",
    error: "‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø",
    checkConnection: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç",
    disclaimer: "‡§ï‡•Ä‡§Æ‡§§‡•á‡§Ç ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§® ‡§π‡•à‡§Ç‡•§ ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§ï‡•Ä‡§Æ‡§§‡•á‡§Ç ‡§≠‡§ø‡§®‡•ç‡§® ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡§Ç‡•§",
    project: "AI for Bharat ‚Äì Crop Price & Market Advisor"
  },
  en: {
    code: "English",
    english: "English",
    location: "Lucknow, Uttar Pradesh",
    heroLabel: "üöÄ AI for Bharat",
    heroTitle: "Smart prices<br/>for <em>every harvest</em>",
    heroSub: "Live crop rates with 7-day AI forecasts ‚Äî helping farmers find the best markets.",
    onion: "Onion",
    potato: "Potato",
    wheat: "Wheat",
    tomato: "Tomato",
    rice: "Rice",
    vegetable: "Vegetable",
    grain: "Grain",
    recommendedMarket: "Recommended Market",
    avgPrice: "Average Price (7 days)",
    perQuintal: "per quintal",
    forecast7Days: "üìä 7-Day Forecast",
    viewForecast: "View",
    hideForecast: "Hide",
    priceRange: "Price Range",
    predictedPrice: "Predicted Price",
    lower: "Low",
    upper: "High",
    chooseLang: "Choose Language",
    loading: "Loading data...",
    error: "Error loading data",
    checkConnection: "Please check your internet connection",
    disclaimer: "Prices are advisory predictions based on publicly available data. Actual market prices may vary.",
    project: "AI for Bharat ‚Äì Crop Price & Market Advisor"
  },
  mr: {
    code: "‡§Æ‡§∞‡§æ‡§†‡•Ä",
    english: "Marathi",
    location: "‡§≤‡§ñ‡§®‡•å, ‡§â‡§§‡•ç‡§§‡§∞‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞",
    heroLabel: "üöÄ ‡§≠‡§æ‡§∞‡§§‡§∏‡§æ‡§†‡•Ä AI",
    heroTitle: "‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§™‡§ø‡§ï‡§æ‡§∏‡§æ‡§†‡•Ä<br/><em>‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§¶‡§æ‡§Æ</em>",
    heroSub: "AI ‡§¶‡•ç‡§µ‡§æ‡§∞‡•á ‡§≤‡§æ‡§á‡§µ ‡§™‡§ø‡§ï‡§æ‡§ö‡•á ‡§¶‡§æ‡§Æ ‡§Ü‡§£‡§ø 7-‡§¶‡§ø‡§µ‡§∏‡§æ‡§Ç‡§ö‡§æ ‡§Ö‡§Ç‡§¶‡§æ‡§ú ‚Äî ‡§∂‡•á‡§§‡§ï‡§∞‡•Ä‡§Ç‡§®‡§æ ‡§∏‡§∞‡•ç‡§µ‡•ã‡§§‡•ç‡§§‡§Æ ‡§Æ‡§Ç‡§°‡•Ä ‡§∂‡•ã‡§ß‡§£‡•ç‡§Ø‡§æ‡§∏ ‡§Æ‡§¶‡§§.",
    onion: "‡§ï‡§æ‡§Ç‡§¶‡§æ",
    potato: "‡§¨‡§ü‡§æ‡§ü‡§æ",
    wheat: "‡§ó‡§µ‡•ç‡§π‡§æ‡§ö‡§æ",
    tomato: "‡§ü‡•ã‡§Æ‡•Ö‡§ü‡•ã",
    rice: "‡§§‡§æ‡§Ç‡§¶‡•Ç‡§≥",
    vegetable: "‡§≠‡§æ‡§ú‡•Ä",
    grain: "‡§ß‡§æ‡§®‡•ç‡§Ø",
    recommendedMarket: "‡§∂‡§ø‡§´‡§æ‡§∞‡§∏ ‡§ï‡•á‡§≤‡•á‡§≤‡•Ä ‡§Æ‡§Ç‡§°‡•Ä",
    avgPrice: "‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä ‡§ï‡§ø‡§Ç‡§Æ‡§§ (7 ‡§¶‡§ø‡§µ‡§∏)",
    perQuintal: "‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤",
    forecast7Days: "üìä 7-‡§¶‡§ø‡§µ‡§∏‡§æ‡§Ç‡§ö‡§æ ‡§Ö‡§Ç‡§¶‡§æ‡§ú",
    viewForecast: "‡§™‡§π‡§æ",
    hideForecast: "‡§≤‡§™‡§µ‡§æ",
    priceRange: "‡§ï‡§ø‡§Ç‡§Æ‡§§ ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä",
    predictedPrice: "‡§Ö‡§Ç‡§¶‡§æ‡§ú‡§ø‡§§ ‡§ï‡§ø‡§Ç‡§Æ‡§§",
    lower: "‡§ï‡§Æ‡•Ä",
    upper: "‡§ú‡§æ‡§∏‡•ç‡§§",
    chooseLang: "‡§≠‡§æ‡§∑‡§æ ‡§®‡§ø‡§µ‡§°‡§æ",
    loading: "‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...",
    error: "‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä",
    checkConnection: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•á ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§§‡§™‡§æ‡§∏‡§æ",
    disclaimer: "‡§ï‡§ø‡§Ç‡§Æ‡§§‡•Ä ‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§°‡•á‡§ü‡§æ‡§µ‡§∞ ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§∏‡§≤‡•ç‡§≤‡§æ‡§ó‡§æ‡§∞ ‡§Ö‡§Ç‡§¶‡§æ‡§ú ‡§Ü‡§π‡•á‡§§. ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§ï‡§ø‡§Ç‡§Æ‡§§‡•Ä ‡§≠‡§ø‡§®‡•ç‡§® ‡§Ö‡§∏‡•Ç ‡§∂‡§ï‡§§‡§æ‡§§.",
    project: "AI for Bharat ‚Äì Crop Price & Market Advisor"
  },
  ta: {
    code: "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç",
    english: "Tamil",
    location: "‡Æ≤‡Æï‡Øç‡Æï‡Æ©‡Øã, ‡Æâ‡Æ§‡Øç‡Æ§‡Æ∞ ‡Æ™‡Æø‡Æ∞‡Æ§‡Øá‡Æö‡ÆÆ‡Øç",
    heroLabel: "üöÄ ‡Æ™‡Ææ‡Æ∞‡Æ§‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ AI",
    heroTitle: "‡Æí‡Æµ‡Øç‡Æµ‡Øä‡Æ∞‡ØÅ ‡ÆÖ‡Æ±‡ØÅ‡Æµ‡Æü‡Øà‡Æï‡Øç‡Æï‡Ææ‡Æï<br/><em>‡Æ∏‡Øç‡ÆÆ‡Ææ‡Æ∞‡Øç‡Æü‡Øç ‡Æµ‡Æø‡Æ≤‡Øà</em>",
    heroSub: "AI ‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç ‡Æ®‡Øá‡Æ∞‡Æü‡Æø ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç 7-‡Æ®‡Ææ‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‚Äî ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ‡Æø‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æö‡Æø‡Æ±‡Æ®‡Øç‡Æ§ ‡Æö‡Æ®‡Øç‡Æ§‡Øà‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡ÆØ ‡Æâ‡Æ§‡Æµ‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.",
    onion: "‡Æµ‡ØÜ‡Æô‡Øç‡Æï‡Ææ‡ÆØ‡ÆÆ‡Øç",
    potato: "‡Æâ‡Æ∞‡ØÅ‡Æ≥‡Øà‡Æï‡Øç‡Æï‡Æø‡Æ¥‡Æô‡Øç‡Æï‡ØÅ",
    wheat: "‡Æï‡Øã‡Æ§‡ØÅ‡ÆÆ‡Øà",
    tomato: "‡Æ§‡Æï‡Øç‡Æï‡Ææ‡Æ≥‡Æø",
    rice: "‡ÆÖ‡Æ∞‡Æø‡Æö‡Æø",
    vegetable: "‡Æï‡Ææ‡ÆØ‡Øç‡Æï‡Æ±‡Æø",
    grain: "‡Æ§‡Ææ‡Æ©‡Æø‡ÆØ‡ÆÆ‡Øç",
    recommendedMarket: "‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æö‡Æ®‡Øç‡Æ§‡Øà",
    avgPrice: "‡Æö‡Æ∞‡Ææ‡Æö‡Æ∞‡Æø ‡Æµ‡Æø‡Æ≤‡Øà (7 ‡Æ®‡Ææ‡Æü‡Øç‡Æï‡Æ≥‡Øç)",
    perQuintal: "‡Æí‡Æ∞‡ØÅ ‡Æï‡ØÅ‡Æµ‡Æø‡Æ£‡Øç‡Æü‡Ææ‡Æ≤‡Øç",
    forecast7Days: "üìä 7-‡Æ®‡Ææ‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ±‡Æø‡Æµ‡Æø‡Æ™‡Øç‡Æ™‡ØÅ",
    viewForecast: "‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
    hideForecast: "‡ÆÆ‡Æ±‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
    priceRange: "‡Æµ‡Æø‡Æ≤‡Øà ‡Æµ‡Æ∞‡ÆÆ‡Øç‡Æ™‡ØÅ",
    predictedPrice: "‡Æï‡Æ£‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æ≤‡Øà",
    lower: "‡Æï‡ØÅ‡Æ±‡Øà‡Æµ‡ØÅ",
    upper: "‡ÆÖ‡Æ§‡Æø‡Æï‡ÆÆ‡Øç",
    chooseLang: "‡ÆÆ‡Øä‡Æ¥‡Æø ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ",
    loading: "‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
    error: "‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡Æµ‡Æ§‡Æø‡Æ≤‡Øç ‡Æ™‡Æø‡Æ¥‡Øà",
    checkConnection: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æá‡Æ£‡Øà‡ÆØ ‡Æá‡Æ£‡Øà‡Æ™‡Øç‡Æ™‡Øà‡Æö‡Øç ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
    disclaimer: "‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øç ‡Æ™‡Øä‡Æ§‡ØÅ ‡Æ§‡Æ∞‡Æµ‡Æø‡Æ©‡Øç ‡ÆÖ‡Æü‡Æø‡Æ™‡Øç‡Æ™‡Æü‡Øà‡ÆØ‡Æø‡Æ≤‡Ææ‡Æ© ‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà ‡Æï‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÜ‡Æï‡ØÅ‡ÆÆ‡Øç. ‡Æâ‡Æ£‡Øç‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ© ‡Æö‡Æ®‡Øç‡Æ§‡Øà ‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øç ‡ÆÆ‡Ææ‡Æ±‡ØÅ‡Æ™‡Æü‡Æ≤‡Ææ‡ÆÆ‡Øç.",
    project: "AI for Bharat ‚Äì Crop Price & Market Advisor"
  }
};

const langOrder = ['hi','en','mr','ta'];
let currentLang = 'hi';
let cropsData = [];

/* ============================================================
   CROP METADATA
   ============================================================ */
const cropMeta = {
  onion: { emoji: 'üßÖ', category: 'vegetable' },
  potato: { emoji: 'ü•î', category: 'vegetable' },
  tomato: { emoji: 'üçÖ', category: 'vegetable' },
  wheat: { emoji: 'üåæ', category: 'grain' },
  rice: { emoji: 'üåæ', category: 'grain' }
};

/* ============================================================
   API FUNCTIONS
   ============================================================ */
async function fetchCropData() {
  try {
    const response = await fetch(API_URL);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    return data;
  } catch (error) {
    console.error('API Error:', error);
    throw error;
  }
}

/* ============================================================
   RENDER FUNCTIONS
   ============================================================ */
function renderCrops(apiData) {
  let crops = [];
  
  if (apiData?.data?.data && Array.isArray(apiData.data.data)) {
    crops = apiData.data.data;
  } else if (apiData?.data && Array.isArray(apiData.data)) {
    crops = apiData.data;
  }
  
  if (crops.length === 0) {
    showError('No data available');
    return;
  }
  
  cropsData = crops;
  
  const container = document.createElement('div');
  container.className = 'crops-container';
  
  crops.forEach(crop => {
    container.appendChild(createCropCard(crop));
  });
  
  document.getElementById('mainContent').innerHTML = '';
  document.getElementById('mainContent').appendChild(container);
  document.getElementById('disclaimer').style.display = 'block';
  
  applyLang(currentLang);
}

function createCropCard(cropData) {
  const t = langs[currentLang];
  const cropName = cropData.crop;
  const meta = cropMeta[cropName] || { emoji: 'üå±', category: 'vegetable' };
  const market = cropData.recommended_market;
  const forecast = cropData.next_7_days_forecast || [];
  const explanation = cropData.explanation || {};
  
  const card = document.createElement('div');
  card.className = 'crop-card';
  card.dataset.crop = cropName;
  
  // Calculate price range
  const avgPrice = market?.predicted_average_price || 0;
  const firstDay = forecast[0] || {};
  const lowerBound = firstDay.lower_bound || avgPrice * 0.95;
  const upperBound = firstDay.upper_bound || avgPrice * 1.05;
  
  card.innerHTML = `
    <div class="crop-header">
      <div class="crop-emoji">${meta.emoji}</div>
      <div class="crop-title-section">
        <div class="crop-name" data-i18n="${cropName}"></div>
        <span class="crop-category ${meta.category}" data-i18n="${meta.category}"></span>
      </div>
    </div>
    
    <div class="market-recommendation">
      <div class="market-label" data-i18n="recommendedMarket"></div>
      <div class="market-name">${market?.market || 'N/A'}</div>
      <div class="market-state">${market?.state || ''}</div>
      <div class="market-price">
        ‚Çπ${avgPrice.toLocaleString('en-IN')}
        <span class="unit" data-i18n="perQuintal"></span>
      </div>
    </div>
    
    <div class="explanation">
      <span class="explanation-icon">üí°</span>
      <span class="explanation-text"></span>
    </div>
    
    <div class="price-range">
      <div class="range-label">
        <span><span data-i18n="lower"></span>: ‚Çπ${Math.round(lowerBound).toLocaleString('en-IN')}</span>
        <span><span data-i18n="upper"></span>: ‚Çπ${Math.round(upperBound).toLocaleString('en-IN')}</span>
      </div>
      <div class="range-bar">
        <div class="range-indicator" style="left: ${((avgPrice - lowerBound) / (upperBound - lowerBound)) * 100}%"></div>
      </div>
    </div>
    
    ${forecast.length > 0 ? `
    <div class="forecast-section">
      <div class="forecast-header">
        <div class="forecast-title">
          <span data-i18n="forecast7Days"></span>
        </div>
        <button class="expand-btn" onclick="toggleForecast(this)">
          <span data-i18n="viewForecast"></span>
          <span class="arrow">‚ñº</span>
        </button>
      </div>
      <div class="forecast-grid">
        <div class="chart-container" id="chart-${cropName}"></div>
        <div class="forecast-legend">
          <div class="legend-item">
            <div class="legend-color legend-predicted"></div>
            <span data-i18n="predictedPrice"></span>
          </div>
          <div class="legend-item">
            <div class="legend-color legend-range"></div>
            <span data-i18n="priceRange"></span>
          </div>
        </div>
      </div>
    </div>
    ` : ''}
  `;
  
  // Set explanation text
  const explanationText = card.querySelector('.explanation-text');
  if (currentLang === 'hi' && explanation.hindi) {
    explanationText.textContent = explanation.hindi;
  } else if (explanation.english) {
    explanationText.textContent = explanation.english;
  }
  

  
  return card;
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  const day = date.getDate();
  const month = date.toLocaleDateString('en', { month: 'short' });
  return `${day} ${month}`;
}

function renderChart(container, forecast) {
  const width = container.offsetWidth;
  const height = 200;
  const padding = { top: 20, right: 10, bottom: 30, left: 45 };
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;
  
  // Extract data
  const prices = forecast.map(d => d.predicted_price);
  const lowerBounds = forecast.map(d => d.lower_bound);
  const upperBounds = forecast.map(d => d.upper_bound);
  const dates = forecast.map(d => formatDate(d.date));
  
  // Calculate scales
  const minPrice = Math.min(...lowerBounds);
  const maxPrice = Math.max(...upperBounds);
  const priceRange = maxPrice - minPrice;
  const yMin = minPrice - priceRange * 0.1;
  const yMax = maxPrice + priceRange * 0.1;
  
  const xScale = (i) => padding.left + (i / (forecast.length - 1)) * chartWidth;
  const yScale = (price) => padding.top + chartHeight - ((price - yMin) / (yMax - yMin)) * chartHeight;
  
  // Create SVG
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('class', 'chart-svg');
  svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
  svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
  
  // Create area path for range band
  let areaPath = `M ${xScale(0)} ${yScale(lowerBounds[0])}`;
  for (let i = 0; i < forecast.length; i++) {
    areaPath += ` L ${xScale(i)} ${yScale(lowerBounds[i])}`;
  }
  for (let i = forecast.length - 1; i >= 0; i--) {
    areaPath += ` L ${xScale(i)} ${yScale(upperBounds[i])}`;
  }
  areaPath += ' Z';
  
  const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  area.setAttribute('d', areaPath);
  area.setAttribute('class', 'range-band');
  svg.appendChild(area);
  
  // Create line path for predicted prices
  let linePath = `M ${xScale(0)} ${yScale(prices[0])}`;
  for (let i = 1; i < prices.length; i++) {
    linePath += ` L ${xScale(i)} ${yScale(prices[i])}`;
  }
  
  const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  line.setAttribute('d', linePath);
  line.setAttribute('class', 'chart-line');
  svg.appendChild(line);
  
  // Add grid lines (horizontal)
  const gridLineCount = 3;
  for (let i = 0; i <= gridLineCount; i++) {
    const y = padding.top + (i / gridLineCount) * chartHeight;
    const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    gridLine.setAttribute('x1', padding.left);
    gridLine.setAttribute('y1', y);
    gridLine.setAttribute('x2', padding.left + chartWidth);
    gridLine.setAttribute('y2', y);
    gridLine.setAttribute('class', 'chart-grid-line');
    svg.appendChild(gridLine);
    
    // Add price labels
    const price = yMax - (i / gridLineCount) * (yMax - yMin);
    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    label.setAttribute('x', padding.left - 8);
    label.setAttribute('y', y + 4);
    label.setAttribute('text-anchor', 'end');
    label.setAttribute('class', 'chart-value');
    label.textContent = '‚Çπ' + Math.round(price);
    svg.appendChild(label);
  }
  
  // Add points and labels
  prices.forEach((price, i) => {
    // Point
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', xScale(i));
    circle.setAttribute('cy', yScale(price));
    circle.setAttribute('r', '4');
    circle.setAttribute('class', 'chart-point');
    
    // Tooltip on hover
    const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
    title.textContent = `${dates[i]}: ‚Çπ${Math.round(price)}`;
    circle.appendChild(title);
    
    svg.appendChild(circle);
    
    // Date label
    const dateLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    dateLabel.setAttribute('x', xScale(i));
    dateLabel.setAttribute('y', height - 10);
    dateLabel.setAttribute('text-anchor', 'middle');
    dateLabel.setAttribute('class', 'chart-label');
    dateLabel.textContent = dates[i];
    svg.appendChild(dateLabel);
  });
  
  container.innerHTML = '';
  container.appendChild(svg);
}

function toggleForecast(btn) {
  const t = langs[currentLang];
  const card = btn.closest('.crop-card');
  const grid = card.querySelector('.forecast-grid');
  const chartContainer = grid.querySelector('.chart-container');
  const cropName = card.dataset.crop;
  const cropData = cropsData.find(c => c.crop === cropName);

  const isVisible = grid.classList.contains('visible');

  if (isVisible) {
    grid.classList.remove('visible');
    btn.classList.remove('expanded');
    btn.querySelector('[data-i18n]').textContent = t.viewForecast;
  } else {
    grid.classList.add('visible');
    btn.classList.add('expanded');
    btn.querySelector('[data-i18n]').textContent = t.hideForecast;

    // ‚¨ÖÔ∏è render ONLY after visible
    if (!chartContainer.dataset.rendered) {
      renderChart(chartContainer, cropData.next_7_days_forecast);
      chartContainer.dataset.rendered = "true";
    }
  }
}

function showError(message) {
  const t = langs[currentLang];
  document.getElementById('mainContent').innerHTML = `
    <div class="error-message">
      <strong>${t.error}</strong><br/>
      ${message}<br/><br/>
      ${t.checkConnection}
    </div>
  `;
}

/* ============================================================
   LANGUAGE FUNCTIONS
   ============================================================ */
function applyLang(code) {
  const t = langs[code];
  if (!t) return;
  currentLang = code;

  const isDark = document.body.classList.contains('dark');
  document.body.className = (isDark ? 'dark ' : '') + 'lang-' + code;
  document.documentElement.setAttribute('lang', code);

  document.getElementById('langCode').textContent = t.code;

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (t[key] !== undefined) el.textContent = t[key];
  });

  document.querySelectorAll('[data-i18n-html]').forEach(el => {
    const key = el.dataset.i18nHtml;
    if (t[key] !== undefined) el.innerHTML = t[key];
  });

  document.querySelectorAll('.lang-option').forEach(el => {
    el.classList.toggle('active', el.dataset.lang === code);
  });
  
  // Update explanations
  document.querySelectorAll('.crop-card').forEach(card => {
    const cropName = card.dataset.crop;
    const cropData = cropsData.find(c => c.crop === cropName);
    if (cropData && cropData.explanation) {
      const explanationText = card.querySelector('.explanation-text');
      if (code === 'hi' && cropData.explanation.hindi) {
        explanationText.textContent = cropData.explanation.hindi;
      } else if (cropData.explanation.english) {
        explanationText.textContent = cropData.explanation.english;
      }
    }
  });
}

function buildLangList() {
  const list = document.getElementById('langList');
  list.innerHTML = '';
  langOrder.forEach(code => {
    const t = langs[code];
    const el = document.createElement('div');
    el.className = 'lang-option' + (code === currentLang ? ' active' : '');
    el.dataset.lang = code;
    el.innerHTML = `
      <span class="lang-flag">üáÆüá≥</span>
      <div class="lang-text">
        <span class="lang-native">${t.code}</span>
        <span class="lang-english">${t.english}</span>
      </div>
      <div class="lang-check">‚úì</div>
    `;
    el.addEventListener('click', () => { applyLang(code); closeDrawer(); });
    list.appendChild(el);
  });
}

function toggleDrawer() {
  const drawer = document.getElementById('langDrawer');
  drawer.classList.contains('visible') ? closeDrawer() : openDrawer();
}

function openDrawer() {
  buildLangList();
  document.getElementById('langOverlay').classList.add('visible');
  document.getElementById('langDrawer').classList.add('visible');
  document.getElementById('langBtn').classList.add('open');
}

function closeDrawer() {
  document.getElementById('langOverlay').classList.remove('visible');
  document.getElementById('langDrawer').classList.remove('visible');
  document.getElementById('langBtn').classList.remove('open');
}

function toggleTheme() {
  document.body.classList.toggle('dark');
  localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
}

/* ============================================================
   INITIALIZATION
   ============================================================ */
async function init() {
  // Load saved theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark');
  }
  
  applyLang('hi');
  
  try {
    const data = await fetchCropData();
    renderCrops(data);
  } catch (error) {
    showError(error.message);
  }
}

// Event listeners
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDrawer();
});

// Initialize app
init();

// Auto-refresh every 10 minutes
setInterval(init, 10 * 60 * 1000);
</script>
</body>
</html>